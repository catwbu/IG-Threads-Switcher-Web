<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG/Threads 網址轉換器</title>

    <link rel="icon" href="icon2.png" type="image/png">
    <link rel="apple-touch-icon" href="icon2.png">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h1 { color: #f0f0f0; margin-top: 0; margin-bottom: 20px; font-size: 24px; }
        #urlInput {
            width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 6px;
            border: 1px solid #444; background-color: #2c2c2c; color: #fff;
            font-size: 16px; box-sizing: border-box;
        }
        #urlInput::placeholder { color: #888; }
        #goButton {
            width: 100%; padding: 15px; background-color: #f2f1ef; color: #121212;
            font-size: 18px; font-weight: bold; border: none; border-radius: 6px;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        #goButton:hover { background-color: #e0e0e0; }
        #goButton:active { background-color: #cccccc; }
        #statusText { margin-top: 15px; color: #ff5252; min-height: 20px; font-size: 14px; }
        .clipboard-info { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        /* 新增隱藏iframe用於處理自動開啟 */
        #appFrame {
            display: none;
            width: 1px;
            height: 1px;
            position: absolute;
            top: -100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IG/Threads 轉換器</h1>
        <p class="clipboard-info">將嘗試自動讀取剪貼簿中的網址並開啟 App</p>
        <input type="text" id="urlInput" placeholder="貼上或等待自動填入網址">
        <button id="goButton">轉換並開啟</button>
        <p id="statusText"></p>
    </div>
    <!-- 新增用於自動開啟的隱藏iframe -->
    <iframe id="appFrame"></iframe>

    <script>
        const urlInput = document.getElementById('urlInput');
        const goButton = document.getElementById('goButton');
        const statusText = document.getElementById('statusText');
        const appFrame = document.getElementById('appFrame');
        let pageJustLoaded = true; // 標記頁面剛載入

        function getUsernameAndType(url) { // 返回包含 type 的 userInfo
            let username = null;
            if (!url || typeof url !== 'string') return null;
            let igMatch = url.match(/instagram\.com\/([a-zA-Z0-9._]+)(?:\/(?!p\/|reel\/|reels\/|$))?/);
            if (igMatch && igMatch[1]) {
                if (!['p', 'reel', 'reels', 'stories', 'explore', 'accounts', 'direct'].includes(igMatch[1])) {
                    username = igMatch[1];
                    return { type: 'instagram', username: username };
                }
            }
            let threadsMatch = url.match(/threads\.(?:net|com)\/@([a-zA-Z0-9._]+)(?:\/|$)/);
            if (threadsMatch && threadsMatch[1]) {
                username = threadsMatch[1];
                return { type: 'threads', username: username };
            }
            return null;
        }

        function generateUrls(originalUrl) {
            const userInfo = getUsernameAndType(originalUrl.trim());
            let urls = {
                customScheme: null,
                https: null,
                targetApp: null // 'instagram' or 'threads'
            };

            if (userInfo && userInfo.username) {
                urls.targetApp = userInfo.type;
                if (userInfo.type === 'instagram') {
                    urls.customScheme = `instagram://user?username=${userInfo.username}`;
                    urls.https = `https://www.instagram.com/${userInfo.username}/`; // 轉換到 IG
                } else if (userInfo.type === 'threads') {
                    // Threads 的 username-based custom scheme 不明確，優先使用 HTTPS Universal Link
                    // 這裡我們將 customScheme 設為 null 或與 https 相同，因為主要依賴 universal link
                    urls.customScheme = null; // 或者可以嘗試 `threads://profile/${userInfo.username}` 但不保證有效
                    urls.https = `https://www.threads.net/@${userInfo.username}/`; // 轉換到 Threads
                }
            }
            return urls;
        }

        // 嘗試使用iframe開啟custom scheme
        function openWithIframe(url) {
            appFrame.src = url;
            return new Promise((resolve) => {
                setTimeout(() => resolve(), 300); // 短暫等待iframe嘗試開啟app
            });
        }

        // 直接嘗試window.location開啟
        function openWithLocation(url) {
            window.location.href = url;
        }

        // 嘗試使用window.open開啟
        function openWithWindowOpen(url) {
            try {
                const newWindow = window.open(url, '_blank');
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    return false; // 彈出視窗被阻擋
                }
                return true;
            } catch (e) {
                console.error("Error opening window:", e);
                return false;
            }
        }

        async function performConversionAndOpen(originalUrl, isAutoAttempt = false) {
            const urls = generateUrls(originalUrl);
            const targetUrl = urls.https; // 預設使用轉換後的 HTTPS URL
            const customSchemeUrl = urls.customScheme;
            const targetApp = urls.targetApp;

            const shortHttpsUrl = targetUrl ? (targetUrl.length > 50 ? targetUrl.substring(0, 47) + '...' : targetUrl) : "";

            if (!targetUrl) {
                const shortOriginalUrl = originalUrl.length > 30 ? originalUrl.substring(0, 27) + '...' : originalUrl;
                statusText.textContent = `網址 "${shortOriginalUrl}" 無法轉換。請檢查網址。`;
                return;
            }

            statusText.textContent = `轉換成功！正在${isAutoAttempt ? "嘗試自動開啟" : "開啟"} ${targetApp}...`;

            // 設置頁面可見性變化監聽
            let appOpened = false;
            const visibilityChangeHandler = () => {
                if (document.hidden || (document.visibilityState && document.visibilityState === 'hidden')) {
                    appOpened = true; // 頁面不可見了，可能 App 已開啟
                    console.log("Page became hidden, assuming app opened.");
                    document.removeEventListener("visibilitychange", visibilityChangeHandler);
                    document.removeEventListener("webkitvisibilitychange", visibilityChangeHandler);
                }
            };
            document.addEventListener("visibilitychange", visibilityChangeHandler);
            document.addEventListener("webkitvisibilitychange", visibilityChangeHandler); // Safari

            if (targetApp === 'instagram' && customSchemeUrl) {
                statusText.textContent = `嘗試開啟 Instagram App...`;
                
                if (isAutoAttempt) {
                    // 自動處理時，先用iframe嘗試開啟custom scheme，然後才是location
                    await openWithIframe(customSchemeUrl);
                    
                    // 短暫延遲檢查是否已開啟app
                    setTimeout(() => {
                        if (!appOpened) {
                            console.log("Instagram app via iframe failed, trying direct location change");
                            openWithLocation(customSchemeUrl);
                            
                            // 再次延遲檢查，如果還是失敗就用https
                            setTimeout(() => {
                                if (!document.hidden) {
                                    console.log("Instagram app via custom scheme failed, falling back to HTTPS URL.");
                                    statusText.textContent = `App 未自動開啟，嘗試網頁版...`;
                                    openWithLocation(targetUrl); // Fallback to HTTPS
                                }
                            }, 1000);
                        }
                    }, 500);
                } else {
                    // 手動點擊時直接嘗試open
                    const opened = openWithWindowOpen(customSchemeUrl);
                    if (!opened) {
                        // 如果無法開啟新窗口，則嘗試直接導航
                        openWithLocation(customSchemeUrl);
                        
                        // 給一個短暫的延遲來看是否app開啟了
                        setTimeout(() => {
                            if (!document.hidden) {
                                console.log("Instagram app via custom scheme didn't open, falling back to HTTPS URL.");
                                openWithWindowOpen(targetUrl) || openWithLocation(targetUrl);
                            }
                        }, 800);
                    }
                }
            } else if (targetApp === 'threads') {
                statusText.textContent = `嘗試開啟 Threads App...`;
                
                if (isAutoAttempt) {
                    await openWithIframe(targetUrl);
                    
                    setTimeout(() => {
                        if (!appOpened) {
                            openWithLocation(targetUrl);
                        }
                    }, 500);
                } else {
                    openWithWindowOpen(targetUrl) || openWithLocation(targetUrl);
                }
            } else {
                // 對於其他情況直接使用https
                if (isAutoAttempt) {
                    openWithLocation(targetUrl);
                } else {
                    openWithWindowOpen(targetUrl) || openWithLocation(targetUrl);
                }
            }
            
            // 清理事件監聽器
            setTimeout(() => {
                document.removeEventListener("visibilitychange", visibilityChangeHandler);
                document.removeEventListener("webkitvisibilitychange", visibilityChangeHandler);
            }, 3000);
        }

        goButton.addEventListener('click', () => {
            pageJustLoaded = false; // 用戶已互動
            const originalUrl = urlInput.value;
            if (!originalUrl) {
                statusText.textContent = '請輸入或貼上網址。';
                return;
            }
            performConversionAndOpen(originalUrl, false);
        });

        async function tryReadFromClipboardAndProcess() {
            if (!pageJustLoaded) return false; // 如果用戶已經互動過，不再自動處理

            if (!navigator.clipboard || typeof navigator.clipboard.readText !== 'function') {
                statusText.textContent = '此瀏覽器不支援自動讀取剪貼簿';
                return false;
            }
            try {
                if (navigator.permissions && typeof navigator.permissions.query === 'function') {
                    try {
                        const permissionStatus = await navigator.permissions.query({ name: 'clipboard-read' });
                        if (permissionStatus.state === 'denied') {
                            statusText.textContent = '讀取剪貼簿權限被拒。';
                            return false;
                        }
                    } catch (permError) {
                        console.log("Clipboard permission check failed:", permError);
                        // 繼續嘗試讀取，即使權限檢查失敗
                    }
                }
                
                const text = await navigator.clipboard.readText();
                if (text && (text.startsWith('http://') || text.startsWith('https://') || text.includes('.com') || text.includes('.net'))) {
                    urlInput.value = text;
                    performConversionAndOpen(text, true);
                    pageJustLoaded = false; // 自動處理後，也標記為非剛載入狀態
                    return true;
                }
                return false;
            } catch (err) {
                console.error('讀取剪貼簿失敗:', err);
                statusText.textContent = '讀取剪貼簿失敗。請手動貼上網址。';
                return false;
            }
        }
        
        // 頁面加載事件處理
        window.addEventListener('DOMContentLoaded', () => {
            pageJustLoaded = true; // 頁面載入時標記
            
            // 為保證在iOS上能正常運作，延遲必須較長
            setTimeout(() => {
                // 確保在用戶點擊或互動過頁面後才嘗試自動讀取剪貼簿
                document.addEventListener('click', function initialClickHandler() {
                    document.removeEventListener('click', initialClickHandler);
                    setTimeout(tryReadFromClipboardAndProcess, 300);
                }, { once: true });
                
                // 顯示提示，讓用戶知道需要點擊頁面
                statusText.textContent = '點擊頁面以讀取剪貼簿並自動開啟';
            }, 500);
        });

        urlInput.addEventListener('focus', () => {
            pageJustLoaded = false; // 用戶聚焦輸入框，視為互動
        });
        urlInput.addEventListener('input', () => {
            pageJustLoaded = false; // 用戶輸入，視為互動
        });
    </script>
</body>
</html>
