<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG/Threads 網址轉換器</title>

    <link rel="icon" href="icon2.png" type="image/png">
    <link rel="apple-touch-icon" href="icon2.png">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px; /* 限制最大寬度，適合手機 */
            text-align: center;
        }

        h1 {
            color: #f0f0f0;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
        }

        #urlInput {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }

        #urlInput::placeholder {
            color: #888;
        }

        #goButton {
            width: 100%;
            padding: 15px;
            background-color: #f2f1ef;
            color: #121212;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #goButton:hover {
            background-color: #e0e0e0;
        }
         #goButton:active {
            background-color: #cccccc;
        }

        #statusText {
            margin-top: 15px;
            color: #ff5252; /* 紅色用於錯誤/警告 */
            min-height: 20px; /* 避免內容跳動 */
            font-size: 14px;
        }

        .clipboard-info {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IG/Threads 轉換器</h1>
        <p class="clipboard-info">將嘗試自動讀取剪貼簿中的網址並開啟</p>
        <input type="text" id="urlInput" placeholder="貼上或等待自動填入網址">
        <button id="goButton">轉換並開啟</button>
        <p id="statusText"></p>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const goButton = document.getElementById('goButton');
        const statusText = document.getElementById('statusText');

        function getUsername(url) {
            let username = null;
            if (!url || typeof url !== 'string') return null;
            let igMatch = url.match(/instagram\.com\/([a-zA-Z0-9._]+)(?:\/(?!p\/|reel\/|reels\/|$))?/);
            if (igMatch && igMatch[1]) {
                if (!['p', 'reel', 'reels', 'stories', 'explore', 'accounts', 'direct'].includes(igMatch[1])) {
                    username = igMatch[1];
                    return { type: 'instagram', username: username };
                }
            }
            let threadsMatch = url.match(/threads\.(?:net|com)\/@([a-zA-Z0-9._]+)(?:\/|$)/);
            if (threadsMatch && threadsMatch[1]) {
                username = threadsMatch[1];
                return { type: 'threads', username: username };
            }
            return null;
        }

        function convertUrl(originalUrl) {
            if (!originalUrl) return null;
            const userInfo = getUsername(originalUrl.trim());
            let newUrl = null;
            if (userInfo && userInfo.username) {
                if (userInfo.type === 'instagram') {
                    newUrl = `https://www.threads.net/@${userInfo.username}`;
                } else if (userInfo.type === 'threads') {
                    newUrl = `https://www.instagram.com/${userInfo.username}/`;
                }
            }
            return newUrl;
        }

        function performConversionAndOpen(urlToConvert) {
            const newUrl = convertUrl(urlToConvert);
            if (newUrl) {
                statusText.textContent = `轉換成功！正在開啟: ${newUrl.length > 50 ? newUrl.substring(0, 47) + '...' : newUrl}`;
                try {
                    const openedWindow = window.open(newUrl, '_blank');
                    if (!openedWindow || openedWindow.closed || typeof openedWindow.closed === 'undefined') {
                        // This condition checks if the window.open was blocked or failed
                        statusText.textContent = '無法自動開啟新分頁。請檢查彈出視窗封鎖設定，或手動點擊按鈕。';
                    }
                } catch (e) {
                    console.error("Error opening window: ", e);
                    statusText.textContent = '開啟新分頁時發生錯誤。請手動點擊按鈕。';
                }
            } else {
                statusText.textContent = '剪貼簿網址無法轉換。請檢查網址或手動點擊按鈕。';
            }
        }

        goButton.addEventListener('click', () => {
            const originalUrl = urlInput.value;
            if (!originalUrl) {
                statusText.textContent = '請輸入或貼上網址。';
                return;
            }
            performConversionAndOpen(originalUrl);
        });

        async function tryReadFromClipboardAndProcess() {
            if (!navigator.clipboard || typeof navigator.clipboard.readText !== 'function') {
                // statusText.textContent = '您的瀏覽器不支援自動讀取剪貼簿。'; // 可以選擇不顯示此訊息，避免過多提示
                return false; // 表示無法讀取
            }

            try {
                if (navigator.permissions && typeof navigator.permissions.query === 'function') {
                    const permissionStatus = await navigator.permissions.query({ name: 'clipboard-read' });
                    if (permissionStatus.state === 'denied') {
                        statusText.textContent = '讀取剪貼簿權限被拒。請手動操作。';
                        return false;
                    }
                }
                
                const text = await navigator.clipboard.readText();
                if (text && (text.startsWith('http://') || text.startsWith('https://') || text.includes('.com') || text.includes('.net'))) {
                    urlInput.value = text;
                    statusText.textContent = '已從剪貼簿讀取網址，正在嘗試自動轉換...';
                    performConversionAndOpen(text); // <--- 自動轉換和開啟
                    return true; // 表示已處理
                } else if (text) {
                    // statusText.textContent = '剪貼簿內容非有效網址。'; // 如果只是普通文字，不清空輸入框
                    return false;
                } else {
                    return false; // 剪貼簿為空
                }
            } catch (err) {
                console.error('讀取剪貼簿失敗:', err);
                // statusText.textContent = '讀取剪貼簿時發生錯誤。'; // 避免過多錯誤提示干擾
                return false;
            }
        }

        // 頁面載入時和輸入框獲得焦點時，都嘗試讀取並處理
        // 我們只希望自動開啟邏輯執行一次，避免重複開啟
        let autoProcessAttempted = false;

        async function initialAutoProcess() {
            if (autoProcessAttempted) return;
            autoProcessAttempted = true; // 標記已嘗試
            await tryReadFromClipboardAndProcess();
        }
        
        window.addEventListener('load', initialAutoProcess);
        // 當使用者點擊輸入框時，如果之前自動處理失敗或剪貼簿內容已更新，可以再次嘗試，但不強制自動開啟
        urlInput.addEventListener('focus', async () => {
            // 如果輸入框是空的，可以再次嘗試填充，但不自動開啟
            if (!urlInput.value) {
                await tryReadFromClipboardAndProcess(); // 這會再次嘗試填充和開啟
            }
        });

    </script>
</body>
</html>
