<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG/Threads 網址轉換器</title>

    <link rel="icon" href="icon2.png" type="image/png">
    <link rel="apple-touch-icon" href="icon2.png">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px; /* 限制最大寬度，適合手機 */
            text-align: center;
        }

        h1 {
            color: #f0f0f0;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
        }

        #urlInput {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #2c2c2c;
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }

        #urlInput::placeholder {
            color: #888;
        }

        #goButton {
            width: 100%;
            padding: 15px;
            background-color: #f2f1ef;
            color: #121212;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #goButton:hover {
            background-color: #e0e0e0;
        }
         #goButton:active {
            background-color: #cccccc;
        }

        #statusText {
            margin-top: 15px;
            color: #ff5252; /* 紅色用於錯誤/警告 */
            min-height: 20px; /* 避免內容跳動 */
            font-size: 14px;
        }

        .clipboard-info {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IG/Threads 轉換器</h1>
        <p class="clipboard-info">將嘗試自動讀取剪貼簿中的網址並開啟</p>
        <input type="text" id="urlInput" placeholder="貼上或等待自動填入網址">
        <button id="goButton">轉換並開啟</button>
        <p id="statusText"></p>
    </div>

    <script>
                const urlInput = document.getElementById('urlInput');
        const goButton = document.getElementById('goButton');
        const statusText = document.getElementById('statusText');

        function getUsername(url) {
            let username = null;
            if (!url || typeof url !== 'string') return null;
            let igMatch = url.match(/instagram\.com\/([a-zA-Z0-9._]+)(?:\/(?!p\/|reel\/|reels\/|$))?/);
            if (igMatch && igMatch[1]) {
                if (!['p', 'reel', 'reels', 'stories', 'explore', 'accounts', 'direct'].includes(igMatch[1])) {
                    username = igMatch[1];
                    return { type: 'instagram', username: username };
                }
            }
            let threadsMatch = url.match(/threads\.(?:net|com)\/@([a-zA-Z0-9._]+)(?:\/|$)/);
            if (threadsMatch && threadsMatch[1]) {
                username = threadsMatch[1];
                return { type: 'threads', username: username };
            }
            return null;
        }

        function convertUrl(originalUrl) {
            if (!originalUrl) return null;
            const userInfo = getUsername(originalUrl.trim());
            let newUrl = null;
            if (userInfo && userInfo.username) {
                if (userInfo.type === 'instagram') {
                    newUrl = `https://www.threads.net/@${userInfo.username}`;
                } else if (userInfo.type === 'threads') {
                    newUrl = `https://www.instagram.com/${userInfo.username}/`;
                }
            }
            return newUrl;
        }

        // 修改此函數，增加 isAutoAttempt 參數
        function performConversionAndOpen(urlToConvert, isAutoAttempt = false) {
            const newUrl = convertUrl(urlToConvert);
            const shortNewUrl = newUrl ? (newUrl.length > 50 ? newUrl.substring(0, 47) + '...' : newUrl) : "";

            if (newUrl) {
                statusText.textContent = `轉換成功！正在${isAutoAttempt ? "嘗試自動開啟" : "開啟"}: ${shortNewUrl}`;

                if (isAutoAttempt) {
                    // 自動嘗試時，使用 window.location.href 導航當前頁面
                    // 這有助於作業系統攔截 Universal Links/App Links 並啟動 App
                    window.location.href = newUrl;

                    // 由於頁面可能會立即導航離開或被 App 取代，
                    // 很難直接檢測 App 是否成功開啟。
                    // 可以設置一個短暫的延遲來更新狀態，以防萬一頁面還在（例如 App 未安裝或未成功跳轉）。
                    setTimeout(() => {
                        // 這個檢查並不完美，但如果用戶在1.5秒後仍在當前頁面，
                        // 並且瀏覽器沒有隱藏（document.hidden），可能意味著 App 未開啟。
                        if (typeof document.hidden === "undefined" || !document.hidden) {
                           // 可以在此處添加額外的提示，例如："如果 App 未自動開啟，請確保已安裝最新版本。"
                           // 但為了簡潔，目前不添加額外提示。
                        }
                    }, 1500);

                } else {
                    // 手動點擊時，使用 window.open 在新分頁開啟
                    try {
                        const openedWindow = window.open(newUrl, '_blank');
                        if (!openedWindow || openedWindow.closed || typeof openedWindow.closed === 'undefined') {
                            statusText.textContent = '無法開啟新分頁。請檢查彈出視窗封鎖設定。';
                        }
                    } catch (e) {
                        console.error("Error opening window: ", e);
                        statusText.textContent = '開啟新分頁時發生錯誤。';
                    }
                }
            } else {
                const shortOriginalUrl = urlToConvert.length > 30 ? urlToConvert.substring(0, 27) + '...' : urlToConvert;
                statusText.textContent = `網址 "${shortOriginalUrl}" 無法轉換。請檢查網址。`;
            }
        }

        goButton.addEventListener('click', () => {
            const originalUrl = urlInput.value;
            if (!originalUrl) {
                statusText.textContent = '請輸入或貼上網址。';
                return;
            }
            performConversionAndOpen(originalUrl, false); // 手動點擊，isAutoAttempt = false
        });

        async function tryReadFromClipboardAndProcess() {
            if (!navigator.clipboard || typeof navigator.clipboard.readText !== 'function') {
                return false;
            }
            try {
                if (navigator.permissions && typeof navigator.permissions.query === 'function') {
                    const permissionStatus = await navigator.permissions.query({ name: 'clipboard-read' });
                    if (permissionStatus.state === 'denied') {
                        statusText.textContent = '讀取剪貼簿權限被拒。請手動操作。';
                        return false;
                    }
                }
                const text = await navigator.clipboard.readText();
                if (text && (text.startsWith('http://') || text.startsWith('https://') || text.includes('.com') || text.includes('.net'))) {
                    urlInput.value = text;
                    statusText.textContent = '已從剪貼簿讀取網址，正在嘗試自動轉換...';
                    performConversionAndOpen(text, true); // 自動處理，isAutoAttempt = true
                    return true;
                } else if (text) {
                    return false;
                } else {
                    return false;
                }
            } catch (err) {
                console.error('讀取剪貼簿失敗:', err);
                return false;
            }
        }

        let autoProcessAttempted = false;
        async function initialAutoProcess() {
            if (autoProcessAttempted) return;
            autoProcessAttempted = true;
            await tryReadFromClipboardAndProcess();
        }
        
        window.addEventListener('load', initialAutoProcess);
        urlInput.addEventListener('focus', async () => {
            if (!urlInput.value && !autoProcessAttempted) { // 如果首次自動處理未執行或輸入框是空的
                 // 再次嘗試自動處理，這通常發生在用戶與頁面有首次交互（點擊輸入框）後
                await initialAutoProcess();
            } else if (!urlInput.value) { // 如果只是輸入框空了，用戶點擊，嘗試填充但不強制認為是“首次自動開啟”
                if (navigator.clipboard && typeof navigator.clipboard.readText === 'function') {
                    try {
                        const text = await navigator.clipboard.readText();
                        if (text && (text.startsWith('http://') || text.startsWith('https://') || text.includes('.com') || text.includes('.net'))) {
                            urlInput.value = text;
                            statusText.textContent = '已從剪貼簿讀取網址。';
                        }
                    } catch(e) { /* silent fail on focus-paste */ }
                }
            }
        });

    </script>
</body>
</html>
