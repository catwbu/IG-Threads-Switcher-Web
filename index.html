<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG/Threads 網址轉換器</title>

    <link rel="icon" href="icon2.png" type="image/png">
    <link rel="apple-touch-icon" href="icon2.png">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        h1 { color: #f0f0f0; margin-top: 0; margin-bottom: 20px; font-size: 24px; }
        #urlInput {
            width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 6px;
            border: 1px solid #444; background-color: #2c2c2c; color: #fff;
            font-size: 16px; box-sizing: border-box;
        }
        #urlInput::placeholder { color: #888; }
        #goButton {
            width: 100%; padding: 15px; background-color: #f2f1ef; color: #121212;
            font-size: 18px; font-weight: bold; border: none; border-radius: 6px;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        #goButton:hover { background-color: #e0e0e0; }
        #goButton:active { background-color: #cccccc; }
        #statusText { margin-top: 15px; color: #ff5252; min-height: 20px; font-size: 14px; }
        .clipboard-info { font-size: 12px; color: #aaa; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>IG/Threads 轉換器</h1>
        <p class="clipboard-info">將嘗試自動讀取剪貼簿中的網址並開啟 App</p>
        <input type="text" id="urlInput" placeholder="貼上或等待自動填入網址">
        <button id="goButton">轉換並開啟</button>
        <p id="statusText"></p>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const goButton = document.getElementById('goButton');
        const statusText = document.getElementById('statusText');
        let pageJustLoaded = true; // 標記頁面剛載入

        function getUsernameAndType(url) { // 返回包含 type 的 userInfo
            let username = null;
            if (!url || typeof url !== 'string') return null;
            let igMatch = url.match(/instagram\.com\/([a-zA-Z0-9._]+)(?:\/(?!p\/|reel\/|reels\/|$))?/);
            if (igMatch && igMatch[1]) {
                if (!['p', 'reel', 'reels', 'stories', 'explore', 'accounts', 'direct'].includes(igMatch[1])) {
                    username = igMatch[1];
                    return { type: 'instagram', username: username };
                }
            }
            let threadsMatch = url.match(/threads\.(?:net|com)\/@([a-zA-Z0-9._]+)(?:\/|$)/);
            if (threadsMatch && threadsMatch[1]) {
                username = threadsMatch[1];
                return { type: 'threads', username: username };
            }
            return null;
        }

        function generateUrls(originalUrl) {
            const userInfo = getUsernameAndType(originalUrl.trim());
            let urls = {
                customScheme: null,
                https: null,
                targetApp: null // 'instagram' or 'threads'
            };

            if (userInfo && userInfo.username) {
                urls.targetApp = userInfo.type;
                if (userInfo.type === 'instagram') {
                    urls.customScheme = `instagram://user?username=${userInfo.username}`;
                    urls.https = `https://www.instagram.com/${userInfo.username}/`; // 轉換到 IG
                } else if (userInfo.type === 'threads') {
                    // Threads 的 username-based custom scheme 不明確，優先使用 HTTPS Universal Link
                    // 這裡我們將 customScheme 設為 null 或與 https 相同，因為主要依賴 universal link
                    urls.customScheme = null; // 或者可以嘗試 `threads://profile/${userInfo.username}` 但不保證有效
                    urls.https = `https://www.threads.net/@${userInfo.username}/`; // 轉換到 Threads
                }
            }
            return urls;
        }


        function performConversionAndOpen(originalUrl, isAutoAttempt = false) {
            const urls = generateUrls(originalUrl);
            const targetUrl = urls.https; // 預設使用轉換後的 HTTPS URL
            const customSchemeUrl = urls.customScheme;
            const targetApp = urls.targetApp;

            const shortHttpsUrl = targetUrl ? (targetUrl.length > 50 ? targetUrl.substring(0, 47) + '...' : targetUrl) : "";

            if (targetUrl) {
                statusText.textContent = `轉換成功！正在${isAutoAttempt ? "嘗試自動開啟" : "開啟"} ${targetApp}...`;

                if (isAutoAttempt) {
                    let appOpened = false;
                    const fallbackTimeout = 1500; // 等待時間（毫秒）

                    // 頁面可見性改變時的回調
                    const visibilityChangeHandler = () => {
                        if (document.hidden || (document.visibilityState && document.visibilityState === 'hidden')) {
                            appOpened = true; // 頁面不可見了，可能 App 已開啟
                            console.log("Page became hidden, assuming app opened.");
                            document.removeEventListener("visibilitychange", visibilityChangeHandler);
                            document.removeEventListener("webkitvisibilitychange", visibilityChangeHandler); // Safari
                        }
                    };
                    document.addEventListener("visibilitychange", visibilityChangeHandler);
                    document.addEventListener("webkitvisibilitychange", visibilityChangeHandler); // Safari

                    if (targetApp === 'instagram' && customSchemeUrl) {
                        statusText.textContent = `嘗試開啟 Instagram App...`;
                        window.location.href = customSchemeUrl;

                        setTimeout(() => {
                            document.removeEventListener("visibilitychange", visibilityChangeHandler);
                            document.removeEventListener("webkitvisibilitychange", visibilityChangeHandler);
                            if (!appOpened) {
                                console.log("Instagram app via custom scheme likely failed, falling back to HTTPS URL.");
                                statusText.textContent = `App 未自動開啟，嘗試網頁版...`;
                                window.location.href = targetUrl; // Fallback to HTTPS
                            }
                        }, fallbackTimeout);
                    } else if (targetApp === 'threads') { // 對於 Threads，直接嘗試 HTTPS Universal Link
                        statusText.textContent = `嘗試開啟 Threads App...`;
                        window.location.href = targetUrl;
                         setTimeout(() => { // 即使是 Threads，也給一個機會讓用戶看到訊息或處理 fallback
                            document.removeEventListener("visibilitychange", visibilityChangeHandler);
                            document.removeEventListener("webkitvisibilitychange", visibilityChangeHandler);
                            if (!appOpened) {
                                console.log("Threads app via HTTPS universal link navigation might not have switched focus.");
                                // 此處 fallback 意義不大，因為已經導向 HTTPS 了
                                // statusText.textContent = `如果 App 未自動開啟，請檢查是否已安裝。`;
                            }
                        }, fallbackTimeout);
                    } else { // 如果沒有特定 Custom Scheme 或目標 App
                         window.location.href = targetUrl;
                    }
                } else { // 手動點擊
                    try {
                        const openedWindow = window.open(targetUrl, '_blank');
                        if (!openedWindow || openedWindow.closed || typeof openedWindow.closed === 'undefined') {
                            statusText.textContent = '無法開啟新分頁。請檢查彈出視窗封鎖設定。';
                        }
                    } catch (e) {
                        console.error("Error opening window: ", e);
                        statusText.textContent = '開啟新分頁時發生錯誤。';
                    }
                }
            } else {
                const shortOriginalUrl = originalUrl.length > 30 ? originalUrl.substring(0, 27) + '...' : originalUrl;
                statusText.textContent = `網址 "${shortOriginalUrl}" 無法轉換。請檢查網址。`;
            }
        }

        goButton.addEventListener('click', () => {
            pageJustLoaded = false; // 用戶已互動
            const originalUrl = urlInput.value;
            if (!originalUrl) {
                statusText.textContent = '請輸入或貼上網址。';
                return;
            }
            performConversionAndOpen(originalUrl, false);
        });

        async function tryReadFromClipboardAndProcess() {
            if (!pageJustLoaded) return false; // 如果用戶已經互動過，不再自動處理

            if (!navigator.clipboard || typeof navigator.clipboard.readText !== 'function') {
                return false;
            }
            try {
                if (navigator.permissions && typeof navigator.permissions.query === 'function') {
                    const permissionStatus = await navigator.permissions.query({ name: 'clipboard-read' });
                    if (permissionStatus.state === 'denied') {
                        statusText.textContent = '讀取剪貼簿權限被拒。';
                        return false;
                    }
                }
                const text = await navigator.clipboard.readText();
                if (text && (text.startsWith('http://') || text.startsWith('https://') || text.includes('.com') || text.includes('.net'))) {
                    urlInput.value = text;
                    performConversionAndOpen(text, true);
                    pageJustLoaded = false; // 自動處理後，也標記為非剛載入狀態
                    return true;
                }
                return false;
            } catch (err) {
                console.error('讀取剪貼簿失敗:', err);
                return false;
            }
        }
        
        window.addEventListener('load', () => {
            pageJustLoaded = true; // 頁面載入時標記
            setTimeout(tryReadFromClipboardAndProcess, 500); // 稍微延遲以確保頁面準備好
        });

        urlInput.addEventListener('focus', () => {
            pageJustLoaded = false; // 用戶聚焦輸入框，視為互動
        });
        urlInput.addEventListener('input', () => {
            pageJustLoaded = false; // 用戶輸入，視為互動
        });

    </script>
</body>
</html>
